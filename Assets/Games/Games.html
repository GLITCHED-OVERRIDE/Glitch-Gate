<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Glitch Games Menu</title>
<style>
body { margin:0; font-family:sans-serif; background:#000; color:#fff; }
#searchBar { display:block; width:90%; max-width:500px; margin:20px auto; padding:10px; font-size:16px; background:#000; color:red; border:2px solid red; border-radius:5px; }
.menu { display:flex; flex-wrap:wrap; justify-content:center; padding:20px; gap:10px; }
.game-button { background:#000; color:red; border:2px solid red; padding:10px 20px; cursor:pointer; font-weight:bold; border-radius:5px; transition:0.2s; }
.game-button:hover { background:red; color:#000; }
.overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:#000; display:none; justify-content:center; align-items:center; z-index:1000; flex-direction:column; }
.overlay iframe { width:95%; height:90%; border:none; background:#fff; }
.close-btn { margin-bottom:10px; background:red; color:#000; border:none; padding:5px 10px; cursor:pointer; font-weight:bold; border-radius:5px; }
.spinner { color:red; font-size:20px; margin-bottom:10px; display:none; }

/* Warning modal */
#warnModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  color: red;
  display: flex;
  justify-content: center;
  align-items: center;
  text-align: center;
  z-index: 2000;
  flex-direction: column;
  padding: 20px;
}
#warnModal button {
  margin-top: 20px;
  padding: 10px 20px;
  background: red;
  color: #000;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
}
</style>
</head>
<body>

<!-- Warning Modal -->
<div id="warnModal">
  <div>⚠️ Beware: Not all games work properly. Download them from the Web Store to play fully. ⚠️</div>
  <button id="warnOkBtn">OK</button>
</div>

<input type="text" id="searchBar" placeholder="Search Games...">
<div class="menu" id="menu"></div>

<div class="overlay" id="overlay">
  <div class="spinner" id="spinner">Loading...</div>
  <button class="close-btn" id="closeBtn">Close</button>
  <iframe id="gameFrame"></iframe>
</div>

<script>
const menu = document.getElementById('menu');
const overlay = document.getElementById('overlay');
const gameFrame = document.getElementById('gameFrame');
const closeBtn = document.getElementById('closeBtn');
const spinner = document.getElementById('spinner');
const searchBar = document.getElementById('searchBar');
const warnModal = document.getElementById('warnModal');
const warnOkBtn = document.getElementById('warnOkBtn');

// Close warning modal
warnOkBtn.onclick = () => warnModal.style.display = 'none';

closeBtn.onclick = () => {
  overlay.style.display = 'none';
  gameFrame.src = '';
};

// Load HTML into iframe with proper base URL
async function loadGameIntoIframe(url) {
  try {
    spinner.style.display = 'block';
    const res = await fetch(url);
    let html = await res.text();
    
    if(!html.includes('<base')) {
      const baseURL = url.substring(0, url.lastIndexOf('/') + 1);
      html = html.replace('<head>', `<head><base href="${baseURL}">`);
    }

    const blob = new Blob([html], { type: 'text/html' });
    gameFrame.src = URL.createObjectURL(blob);
    overlay.style.display = 'flex';

    gameFrame.onload = () => spinner.style.display = 'none';
  } catch(err) {
    spinner.style.display = 'none';
    console.error('Failed to load game:', err);
    alert('Failed to load game.');
  }
}

// Fetch games JSON
fetch('https://raw.githubusercontent.com/GLITCHED-OVERRIDE/Glitch-Gate/refs/heads/main/Assets/Games/Games.json')
  .then(res => res.json())
  .then(games => {

    function renderButtons(filter="") {
      menu.innerHTML = '';
      games.filter(g => g.name.toLowerCase().includes(filter.toLowerCase()))
           .forEach(game => {
        const btn = document.createElement('button');
        btn.className = 'game-button';
        btn.textContent = game.name.replace('.html','');
        btn.onclick = () => loadGameIntoIframe(game.raw_url);
        menu.appendChild(btn);
      });
    }

    renderButtons();
    searchBar.addEventListener('input', e => renderButtons(e.target.value));
  })
  .catch(err => console.error('Failed to load games JSON:', err));
</script>

</body>
</html>
